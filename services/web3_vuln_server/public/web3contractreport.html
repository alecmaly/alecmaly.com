<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Tables</title>
    <style>
    body {
        font-family: Arial, sans-serif;
    }
    table {
        border-collapse: collapse;
        width: 100%;
    }
    th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
    textarea {
        width: 100%;
        height: 400px;
    }
    h2 {
        top: 0;
        position: sticky;
        background-color: aliceblue;
        z-index: 1;
        padding: 8px;
    }
</style>
</head>
<body>
    <h2>Live Contracts</h2>
    <select id="liveContractsSelection" onchange="generateScript()">
    <option value="address">Address</option>
    <option value="impl_address">Implementation Address</option>
    </select>
    
    <h2>Proxies</h2>
    <select id="proxiesSelection" onchange="generateScript()">
        <option value="address">Address</option>
        <option value="impl_address" selected="selected">Implementation Address</option>
    </select>
    
    <div class='container' style='width: 98.5vw; overflow-x: auto'>
    <table>
<thead><tr><th>Select</th><th>address</th><th>chain</th><th>date</th><th>impl_address</th><th>project</th><th>ProxyCompilerVersion</th><th>ProxyContractName</th><th>type</th><th>max bounty</th><th>prevVersions</th></tr></thead>
<tbody><tr data-patches='' data-proxies='0x21f352fc288b5e030867eed41f7402482b083b02~StakedLBTC'><td><input type='checkbox' class='proxyRow' onchange='generateScript()'></td><td><a target='_blank' href='https://etherscan.io/address/0x8236a87084f8b84306f72007f36f2618a5634494'>0x8236a87084f8b84306f72007f36f2618a5634494</a></td><td>etherscan.io</td><td>2025-11-21</td><td><a target='_blank' href='https://etherscan.io/address/0x21f352fc288b5e030867eed41f7402482b083b02'>0x21f352fc288b5e030867eed41f7402482b083b02</a></td><td>lombard-finance</td><td>v0.8.24+commit.e11b9ed9</td><td>StakedLBTC</td><td>impl_proxy</td><td><a target='_blank' href='https://immunefi.com/bounty/lombard-finance/'>250,000</a></td><td>0 - </td></tr>
</tbody></table></div>    
    <h2>Generated Shell Script</h2>
    <input type='text' id='output_dir' value='source_code' onkeyup="generateScript()" />
    <textarea id="shellScript" readonly></textarea>
    
    <script>

    function generateScript() {
        var scriptLines = [];
        var selectedContractsDetail = [];
        var selectedProxiesDetail = [];
        var allImplementationAddresses = [];
        var seenProxyContracts = []
        var chain = ""; // last selected chain
        var version = "";   // last selected version
        var liveContractsSelection = document.getElementById('liveContractsSelection').value;
        var proxiesSelection = document.getElementById('proxiesSelection').value;
        var output_dir = document.querySelector('#output_dir').value
        var output_dir_param = output_dir ? `-f ${output_dir}` : ""

        var complexScriptPrefix = `
cp ~/Desktop/slither-custom-tooling/tools/solidity/_downloadLiveContracts.py .
`

var complexScriptTemplatePostfix = `
cd ${output_dir}
cpslither
init_web3_fuzz
code .
        `
        // contracts
        document.querySelectorAll('.contactRow:checked').forEach(function(cb) {
            var row = cb.closest('tr');
            let patches = row.getAttribute('data-patches') ? JSON.parse(atob(row.getAttribute('data-patches'))) : []
            
            chain = row.cells[2].textContent
            version = row.cells[3].textContent
            let date = row.cells[5].textContent

            var columnIndex = liveContractsSelection === 'address' ? 1 : 6; // Adjust index based on selection and CSV structure
            var domain = row.cells[2].textContent;
            var value = row.cells[columnIndex].textContent;
            scriptLines.push(`python3 _downloadLiveContracts.py ${domain} ${value} ${output_dir_param}`);
            
            let contractName = row.cells[4].textContent
            let address = row.cells[1].textContent
            selectedContractsDetail.push(`${contractName} = ${address} # ${contractName} ${date}`)

            selectedContractsDetail.push(`	Patch diffs`)
            if (patches.length > 0) {
                for (let patch of patches) {
                    selectedContractsDetail.push(`	python3 _downloadLiveContracts.py ${patch.chain} ${patch.address} -f diff_${patch.ContractName}_${patch.date.replaceAll("/", "_")}`);
                    selectedContractsDetail.push(`	meld ${output_dir} diff_${patch.ContractName}_${patch.date.replaceAll("/", "_")}\n`);
                }
            } else {
                // if no patches, show what commands could be run to diff
                selectedContractsDetail.push(`	python3 _downloadLiveContracts.py ${chain} <prev_addr> -f diff_${contractName}_old`);
                selectedContractsDetail.push(`	meld ${output_dir} diff_${contractName}_old\n`);
            }

            
            if (!seenProxyContracts.includes(address)) {
                allImplementationAddresses.push(`	~~ Download Implementations of proxy ${address} (in scope implementations) ~~`)
                for (let p of row.getAttribute('data-proxies').split(";")) {
                    let [p_addr, p_name] = p.split("~")
                    allImplementationAddresses.push(`	python3 _downloadLiveContracts.py ${domain} ${p_addr} ${output_dir_param} # ${p_name}`)
                }
                allImplementationAddresses.push("")
                seenProxyContracts.push(address)
            }
        });

        // proxies
        document.querySelectorAll('.proxyRow:checked').forEach(function(cb) {
            var row = cb.closest('tr');
            let patches = row.getAttribute('data-patches') ? JSON.parse(atob(row.getAttribute('data-patches'))) : []

            chain = row.cells[2].textContent
            version = row.cells[6].textContent
            let date = row.cells[3].textContent

            var columnIndex = proxiesSelection === 'address' ? 1 : 4; // Adjust index based on selection and CSV structure
            var domain = row.cells[2].textContent;
            var value = row.cells[columnIndex].textContent;
            scriptLines.push(`python3 _downloadLiveContracts.py ${domain} ${value} ${output_dir_param}`);

            let contractName = row.cells[7].textContent
            let address = row.cells[4].textContent
            let proxy_addr = row.cells[1].textContent

            selectedProxiesDetail.push(`${contractName} = ${address} (proxy: ${proxy_addr}) # ${contractName} ${date}`)

            selectedProxiesDetail.push(`	~~ Patch diffs ~~`)
            if (patches.length > 0) {
                for (let patch of patches) {
                    selectedProxiesDetail.push(`	python3 _downloadLiveContracts.py ${patch.chain} ${patch.impl_address} -f diff_${patch.ProxyContractName}_${patch.date.replaceAll("/", "_")}`);
                    selectedProxiesDetail.push(`	meld ${output_dir} diff_${patch.ProxyContractName}_${patch.date.replaceAll("/", "_")}\n`);
                }
            } else {
                // if no patches, show what commands could be run to diff
                selectedProxiesDetail.push(`	python3 _downloadLiveContracts.py ${chain} <prev_addr> -f diff_${contractName}_old`);
                selectedProxiesDetail.push(`	meld ${output_dir} diff_${contractName}_old\n`);
            }

            if (!seenProxyContracts.includes(proxy_addr)) {
                if (allImplementationAddresses.length === 0) {
                    allImplementationAddresses.push(`Related Implementation Contracts`)
                }

                allImplementationAddresses.push(`	~~ Download Implementations of proxy ${proxy_addr} (in scope implementations) ~~`)
                for (let p of row.getAttribute('data-proxies').split(";")) {
                    let [p_addr, p_name] = p.split("~")
                    allImplementationAddresses.push(`	python3 _downloadLiveContracts.py ${domain} ${p_addr} ${output_dir_param} # ${p_name}`)
                }
                allImplementationAddresses.push("")
                seenProxyContracts.push(proxy_addr)
            }

            selectedProxiesDetail.push("")
        });
        version = version.split('+')[0].replace('v', '')

        var complexScript = complexScriptPrefix 
            + `\nsolc-select install ${version}\n` 
            + `solc-select use ${version}\n\n` 
            + scriptLines.join('\n')
            + complexScriptTemplatePostfix
            + `\ncat << EOF > _contract_info.txt\n${chain}\n\n` + selectedContractsDetail.join('\n') + selectedProxiesDetail.join('\n') + allImplementationAddresses.join('\n') + '\nEOF\n'

        document.getElementById('shellScript').value = complexScript;
    }
    </script>
</body>
</html>
